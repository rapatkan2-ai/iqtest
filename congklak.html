<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Congklak Strategi - Simulator</title>
    <link href="styles.css" rel="stylesheet">
    <link href="fonts.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&display=swap"
        rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fun': ['Fredoka', 'sans-serif'], 'body': ['Nunito', 'sans-serif'] },
                    colors: { 'wood-light': '#D4A373', 'wood-dark': '#8B4513', 'wood-accent': '#5D4037', 'surface': '#FAEDCD' },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                }
            }
        }
    </script>
    <style>
        body {
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            background-color: #FAEDCD;
        }

        .btn-touch:active {
            transform: scale(0.95);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 1.5rem;
            cursor: grab;
            touch-action: none;
            transition: all 0.3s ease;
        }

        .glass-card.disabled {
            opacity: 0.6;
            filter: grayscale(100%);
            /* pointer-events: none; REMOVED to allow dragging */
        }

        .numpad-btn {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-family: 'Fredoka', sans-serif;
            font-size: 1.25rem;
            color: #4A5568;
            transition: all 0.1s;
        }

        .numpad-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Board Styling */
        .hole {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #5d4037, #3e2723);
            border-radius: 50%;
            box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.6), 1px 1px 2px rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .hole.active {
            box-shadow: 0 0 0 4px #FCD34D, inset 3px 3px 8px rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
            z-index: 10;
        }

        .hole.active:hover {
            transform: scale(1.15);
        }

        .store {
            width: 90px;
            height: 180px;
            background: radial-gradient(circle at 30% 30%, #5d4037, #3e2723);
            border-radius: 45px;
            box-shadow: inset 4px 4px 10px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .seed {
            width: 12px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
            position: absolute;
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>

<body class="font-body h-screen w-screen flex flex-col text-gray-800">

    <!-- Nav -->
    <div class="fixed top-4 left-4 z-50">
        <button onclick="window.location.href='playground_ifp.html'"
            class="btn-touch bg-white h-12 w-12 rounded-xl shadow-lg flex items-center justify-center text-gray-600 hover:text-wood-dark"><span
                class="material-icons">home</span></button>
    </div>
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleFullscreen()"
            class="btn-touch bg-white h-12 w-12 rounded-xl shadow-lg flex items-center justify-center text-gray-600 hover:text-wood-dark"><span
                class="material-icons">fullscreen</span></button>
    </div>

    <!-- MAIN APP -->
    <main id="app" class="flex-grow relative w-full h-full flex items-center justify-center bg-surface">

        <!-- SETUP SCREEN -->
        <section id="screen-setup" class="w-full max-w-5xl px-4 text-center animate-fade-in-up">
            <h1 class="font-fun text-7xl font-bold text-wood-dark mb-4 drop-shadow-md">CONGKLAK</h1>
            <p class="text-xl text-wood-accent mb-12">Simulasi Strategi & Matematika</p>

            <div class="bg-white/50 backdrop-blur-md p-8 rounded-[2rem] shadow-xl inline-block">
                <h3 class="font-bold text-2xl mb-6 text-wood-dark">Pilih Mode</h3>
                <div class="flex gap-4 justify-center mb-8">
                    <button onclick="startGame(2)"
                        class="btn-touch bg-wood-light text-white px-8 py-4 rounded-2xl font-bold text-xl hover:bg-wood-dark shadow-lg">
                        1 vs 1 (Lokal)
                    </button>
                    <!-- AI Not implemented yet, simplify to 1v1 for now -->
                </div>

                <h3 class="font-bold text-2xl mb-6 text-wood-dark">Tingkat Kesulitan Soal</h3>
                <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                    <button onclick="setDiff('easy')"
                        class="btn-touch border-2 border-green-400 bg-green-50 text-green-700 font-bold py-3 rounded-xl hover:bg-green-100">MUDAH
                        (1-10)</button>
                    <button onclick="setDiff('medium')"
                        class="btn-touch border-2 border-yellow-400 bg-yellow-50 text-yellow-700 font-bold py-3 rounded-xl hover:bg-yellow-100">SEDANG
                        (1-20)</button>
                    <button onclick="setDiff('hard')"
                        class="btn-touch border-2 border-orange-400 bg-orange-50 text-orange-700 font-bold py-3 rounded-xl hover:bg-orange-100">SULIT
                        (10-50)</button>
                    <button onclick="setDiff('expert')"
                        class="btn-touch border-2 border-red-400 bg-red-50 text-red-700 font-bold py-3 rounded-xl hover:bg-red-100">AHLI
                        (10-100)</button>
                </div>
            </div>
        </section>

        <!-- GAME SCREEN -->
        <section id="screen-game" class="hidden absolute inset-0 w-full h-full">

            <!-- GAME BOARD LAYER (Centered) -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div
                    class="bg-[#8B4513] p-6 pb-8 px-10 rounded-[100px] shadow-2xl border-[6px] border-[#5D4037] flex items-center gap-6 relative pointer-events-auto transform scale-[0.8] md:scale-100 transition-transform">
                    <!-- Wood Texture -->
                    <div
                        class="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] rounded-[90px] pointer-events-none">
                    </div>

                    <!-- P2 Store (Left) - Index 15 -->
                    <div id="store-15" class="store flex flex-col items-center justify-center">
                        <span class="text-white font-bold text-2xl z-10 drop-shadow-md select-none"
                            id="count-15">0</span>
                        <div class="absolute -top-10 text-red-600 font-bold bg-white/80 px-2 rounded-lg text-sm">P2
                        </div>
                    </div>

                    <!-- Holes Main Area -->
                    <div class="flex flex-col gap-6">
                        <!-- Top Row: P2 Holes (Index 14 -> 8) -->
                        <div class="flex gap-4">
                            <!-- We render 14 to 8 visually left-to-right? 
                                 No, Congklak track usually goes counter-clockwise or clockwise. 
                                 Let's stick to P2 moves RIGHT-TO-LEFT on top row visually (14,13,12...), so 8 is rightmost of top (closer to P1 store). 
                                 Wait, if P1 moves 0->6->7 (Store), then 8 is next to 7.
                                 So 8 is "Bottom Right" equivalent on top? 
                                 Standard: 
                                 [15]  [14][13][12][11][10][09][08]  [07]
                                       [00][01][02][03][04][05][06]
                                 So P2 Top Row should be rendered 14->8 Left-to-Right.
                            -->
                            <div id="hole-14" onclick="handleHoleClick(14)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">14</span><span
                                    id="count-14"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-13" onclick="handleHoleClick(13)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">13</span><span
                                    id="count-13"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-12" onclick="handleHoleClick(12)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">12</span><span
                                    id="count-12"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-11" onclick="handleHoleClick(11)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">11</span><span
                                    id="count-11"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-10" onclick="handleHoleClick(10)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">10</span><span
                                    id="count-10"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-09" onclick="handleHoleClick(9)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">9</span><span
                                    id="count-9"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-08" onclick="handleHoleClick(8)" class="hole"><span
                                    class="absolute -top-6 text-white text-xs opacity-50 select-none">8</span><span
                                    id="count-8"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                        </div>

                        <!-- Bottom Row: P1 Holes (Index 0 -> 6) -->
                        <div class="flex gap-4">
                            <div id="hole-00" onclick="handleHoleClick(0)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">0</span><span
                                    id="count-0"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-01" onclick="handleHoleClick(1)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">1</span><span
                                    id="count-1"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-02" onclick="handleHoleClick(2)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">2</span><span
                                    id="count-2"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-03" onclick="handleHoleClick(3)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">3</span><span
                                    id="count-3"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-04" onclick="handleHoleClick(4)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">4</span><span
                                    id="count-4"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-05" onclick="handleHoleClick(5)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">5</span><span
                                    id="count-5"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                            <div id="hole-06" onclick="handleHoleClick(6)" class="hole"><span
                                    class="absolute -bottom-6 text-white text-xs opacity-50 select-none">6</span><span
                                    id="count-6"
                                    class="text-white font-bold pointer-events-none z-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">7</span>
                            </div>
                        </div>
                    </div>

                    <!-- P1 Store (Right) - Index 7 -->
                    <div id="store-07" class="store flex flex-col items-center justify-center">
                        <span class="text-white font-bold text-2xl z-10 drop-shadow-md select-none"
                            id="count-7">0</span>
                        <div class="absolute -bottom-10 text-blue-600 font-bold bg-white/80 px-2 rounded-lg text-sm">P1
                        </div>
                    </div>
                </div>
            </div>

            <!-- UI CONTROLS (Floating Calculators) -->
            <div id="ui-layer" class="absolute inset-0 pointer-events-none">
                <!-- P1 Calculator (Bottom Left) -->
                <div id="calc-p1"
                    class="glass-card absolute bottom-4 left-4 p-3 w-64 pointer-events-auto transition-all duration-300 border-t-8 border-blue-600">
                    <div id="hint-p1"
                        class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-bold shadow-lg animate-bounce whitespace-nowrap z-50 pointer-events-none">
                        ðŸ‘‡ Geser posisi
                        <div
                            class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-yellow-400 rotate-45">
                        </div>
                    </div>
                    <div
                        class="bg-blue-600 rounded-lg p-2 text-center text-white font-bold mb-2 flex justify-between cursor-grab active:cursor-grabbing">
                        <div class="flex items-center"><span
                                class="material-icons text-white/50 mr-1 text-sm">drag_indicator</span><span
                                class="text-sm opacity-80">PLAYER 1</span></div>
                        <span id="status-p1" class="text-xs bg-white text-blue-600 px-2 rounded">GILIRANMU!</span>
                    </div>
                    <div id="q-p1" class="bg-blue-50 text-blue-900 font-bold text-center py-2 rounded mb-2 h-8 text-sm">
                        ...</div>
                    <div id="in-p1"
                        class="bg-gray-100 rounded h-10 flex items-center justify-center font-bold text-xl text-gray-700 tracking-widest border border-gray-300 mb-2">
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button class="numpad-btn h-10" onclick="input(1, 1)">1</button>
                        <button class="numpad-btn h-10" onclick="input(1, 2)">2</button>
                        <button class="numpad-btn h-10" onclick="input(1, 3)">3</button>
                        <button class="numpad-btn h-10" onclick="input(1, 4)">4</button>
                        <button class="numpad-btn h-10" onclick="input(1, 5)">5</button>
                        <button class="numpad-btn h-10" onclick="input(1, 6)">6</button>
                        <button class="numpad-btn h-10" onclick="input(1, 7)">7</button>
                        <button class="numpad-btn h-10" onclick="input(1, 8)">8</button>
                        <button class="numpad-btn h-10" onclick="input(1, 9)">9</button>
                        <button class="numpad-btn h-10 text-red-500 font-bold" onclick="input(1, 'C')">C</button>
                        <button class="numpad-btn h-10" onclick="input(1, 0)">0</button>
                        <button class="numpad-btn h-10 bg-blue-600 text-white font-bold shadow-lg"
                            onclick="check(1)">âœ”</button>
                    </div>
                </div>

                <!-- P2 Calculator (Bottom Right) -->
                <div id="calc-p2"
                    class="glass-card absolute bottom-4 right-4 p-3 w-64 pointer-events-auto transition-all duration-300 border-t-8 border-red-600 disabled">
                    <div id="hint-p2"
                        class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-bold shadow-lg animate-bounce whitespace-nowrap z-50 pointer-events-none">
                        ðŸ‘‡ Geser posisi
                        <div
                            class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-yellow-400 rotate-45">
                        </div>
                    </div>
                    <div
                        class="bg-red-600 rounded-lg p-2 text-center text-white font-bold mb-2 flex justify-between cursor-grab active:cursor-grabbing">
                        <div class="flex items-center"><span
                                class="material-icons text-white/50 mr-1 text-sm">drag_indicator</span><span
                                class="text-sm opacity-80">PLAYER 2</span></div>
                        <span id="status-p2" class="text-xs bg-white text-red-600 px-2 rounded hidden">GILIRANMU!</span>
                    </div>
                    <div id="q-p2" class="bg-red-50 text-red-900 font-bold text-center py-2 rounded mb-2 h-8 text-sm">
                        ...</div>
                    <div id="in-p2"
                        class="bg-gray-100 rounded h-10 flex items-center justify-center font-bold text-xl text-gray-700 tracking-widest border border-gray-300 mb-2">
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button class="numpad-btn h-10" onclick="input(2, 1)">1</button>
                        <button class="numpad-btn h-10" onclick="input(2, 2)">2</button>
                        <button class="numpad-btn h-10" onclick="input(2, 3)">3</button>
                        <button class="numpad-btn h-10" onclick="input(2, 4)">4</button>
                        <button class="numpad-btn h-10" onclick="input(2, 5)">5</button>
                        <button class="numpad-btn h-10" onclick="input(2, 6)">6</button>
                        <button class="numpad-btn h-10" onclick="input(2, 7)">7</button>
                        <button class="numpad-btn h-10" onclick="input(2, 8)">8</button>
                        <button class="numpad-btn h-10" onclick="input(2, 9)">9</button>
                        <button class="numpad-btn h-10 text-red-500 font-bold" onclick="input(2, 'C')">C</button>
                        <button class="numpad-btn h-10" onclick="input(2, 0)">0</button>
                        <button class="numpad-btn h-10 bg-red-600 text-white font-bold shadow-lg"
                            onclick="check(2)">âœ”</button>
                    </div>
                </div>
            </div>

            <!-- TURN NOTIFIER -->
            <div id="turn-banner"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/90 backdrop-blur px-8 py-4 rounded-full shadow-2xl z-50 hidden border-4 border-yellow-400">
                <h2 id="turn-text" class="text-3xl font-fun font-bold text-wood-dark">GILIRAN PEMAIN 1</h2>
            </div>

        </section>

        <!-- WINNER SCREEN -->
        <section id="screen-result"
            class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[100]">
            <div
                class="bg-white p-12 rounded-[3rem] text-center max-w-2xl animate-bounce-in shadow-2xl border-8 border-white">
                <h1 id="result-text" class="text-6xl font-bold mb-4 font-fun">PEMAIN 1 MENANG!</h1>
                <div class="flex justify-center gap-12 text-3xl mb-8">
                    <div class="text-blue-600 font-bold">P1: <span id="final-p1"></span></div>
                    <div class="text-red-600 font-bold">P2: <span id="final-p2"></span></div>
                </div>
                <button onclick="location.reload()"
                    class="bg-wood-dark text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:scale-105 transition-transform">MAIN
                    LAGI</button>
                <button onclick="window.location.href='playground_ifp.html'"
                    class="ml-4 bg-gray-200 text-gray-700 px-8 py-4 rounded-xl text-xl font-bold hover:bg-gray-300">KELUAR</button>
            </div>
        </section>

    </main>

    <script>
        // --- GAME LOGIC ---
        // Board: 16 slots.
        // 0-6: P1 Holes
        // 7: P1 Store
        // 8-14: P2 Holes (visually reversed on top)
        // 15: P2 Store
        let board = Array(16).fill(7);
        board[7] = 0; board[15] = 0; // Stores start empty

        let turn = 1; // 1 or 2
        let phase = 'setup'; // setup, math, move, animating
        let diff = 'medium';
        let currentProblem = null;
        let p1Input = '', p2Input = '';

        // DRAG LOGIC
        function makeDraggable(el) {
            let isDragging = false;
            let shiftX, shiftY;

            const onStart = (e) => {
                if (e.target.closest('button')) return; // Allow button clicks

                const hint = el.querySelector('[id^="hint-"]');
                if (hint) hint.remove(); // Remove hint on first drag

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const rect = el.getBoundingClientRect();
                const parentRect = el.offsetParent.getBoundingClientRect();

                shiftX = clientX - rect.left;
                shiftY = clientY - rect.top;

                isDragging = true;

                // Set absolute relative to parent
                el.style.position = 'absolute';
                el.style.left = (rect.left - parentRect.left) + 'px';
                el.style.top = (rect.top - parentRect.top) + 'px';
                el.style.bottom = 'auto';
                el.style.right = 'auto';

                el.style.zIndex = 100;
            };

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const parentRect = el.offsetParent.getBoundingClientRect();

                // Boundary checks could be added here, but free drag is requested
                let newLeft = clientX - shiftX - parentRect.left;
                let newTop = clientY - shiftY - parentRect.top;

                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';
            };

            const onEnd = () => { isDragging = false; el.style.zIndex = 40; };

            el.addEventListener('mousedown', onStart);
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onEnd);
            el.addEventListener('touchstart', onStart, { passive: false });
            window.addEventListener('touchmove', onMove, { passive: false });
            window.addEventListener('touchend', onEnd);
        }

        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => { }); else document.exitFullscreen(); }

        function setDiff(d) { diff = d; document.getElementById('screen-setup').classList.add('hidden'); startGame(2); }

        function startGame(mode) {
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');

            // Enable Drag
            makeDraggable(document.getElementById('calc-p1'));
            makeDraggable(document.getElementById('calc-p2'));

            // Reset
            board = Array(16).fill(7); board[7] = 0; board[15] = 0;
            updateVisuals();

            // Start P1
            setTurn(1);
        }

        function setTurn(playerID) {
            turn = playerID;
            // Phase: MATH first
            phase = 'math';

            // UI Updates
            const p1c = document.getElementById('calc-p1');
            const p2c = document.getElementById('calc-p2');

            if (turn === 1) {
                p1c.classList.remove('disabled'); p2c.classList.add('disabled');
                document.getElementById('status-p1').classList.remove('hidden');
                document.getElementById('status-p2').classList.add('hidden');
            } else {
                p1c.classList.add('disabled'); p2c.classList.remove('disabled');
                document.getElementById('status-p1').classList.add('hidden');
                document.getElementById('status-p2').classList.remove('hidden');
            }

            // Generate Problem
            generateProblem();
        }

        function generateProblem() {
            let max = diff === 'easy' ? 10 : diff === 'medium' ? 20 : 50;
            let a = Math.floor(Math.random() * max) + 1;
            let b = Math.floor(Math.random() * max) + 1;
            currentProblem = { q: `${a} + ${b} = ?`, a: a + b };

            // Show on active calc
            const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
            qEl.innerText = "SOAL: " + currentProblem.q;

            // Highlight holes disabled until solved
            highlightValidHoles(false);
        }

        function input(player, val) {
            if (phase !== 'math' || player !== turn) return;
            let el = player === 1 ? document.getElementById('in-p1') : document.getElementById('in-p2');
            let curr = player === 1 ? p1Input : p2Input;

            if (val === 'C') curr = '';
            else curr += val;

            if (player === 1) p1Input = curr; else p2Input = curr;
            el.innerText = curr;
        }

        function check(player) {
            if (phase !== 'math' || player !== turn) return;
            let curr = player === 1 ? p1Input : p2Input;
            let el = player === 1 ? document.getElementById('in-p1') : document.getElementById('in-p2');

            if (parseInt(curr) === currentProblem.a) {
                // Correct
                el.classList.add('bg-green-100', 'text-green-600');
                setTimeout(() => {
                    el.innerText = 'BENAR!';
                    setTimeout(() => {
                        el.classList.remove('bg-green-100', 'text-green-600');
                        el.innerText = '';
                        if (player === 1) p1Input = ''; else p2Input = '';

                        // UNLOCK BOARD
                        phase = 'move';
                        highlightValidHoles(true);
                        const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
                        qEl.innerText = "PILIH LUBANG!";
                    }, 500);
                }, 200);
            } else {
                // Wrong
                el.classList.add('bg-red-100', 'text-red-500');
                setTimeout(() => el.classList.remove('bg-red-100', 'text-red-500'), 500);
            }
        }

        function highlightValidHoles(active) {
            // Remove all
            document.querySelectorAll('.hole').forEach(h => h.classList.remove('active', 'opacity-50'));

            if (!active) {
                // Dim all
                document.querySelectorAll('.hole').forEach(h => h.classList.add('opacity-50'));
                return;
            }

            // Highlight own side non-empty
            let start = turn === 1 ? 0 : 8;
            let end = turn === 1 ? 6 : 14;

            let hasMove = false;
            for (let i = start; i <= end; i++) {
                if (board[i] > 0) {
                    document.getElementById(`hole-${i < 10 ? '0' + i : i}`).classList.add('active');
                    hasMove = true;
                } else {
                    document.getElementById(`hole-${i < 10 ? '0' + i : i}`).classList.add('opacity-50');
                }
            }

            if (!hasMove) {
                // Game Over or Pass?
                // Standard congklak: if no seeds on your side, opponent keeps playing or game ends?
                // Simplified: End Game or Transfer Turn. 
                // Let's End Game if active player cannot move.
                endGame();
            }
        }

        function handleHoleClick(idx) {
            if (phase !== 'move') return;

            // Validate owner
            if (turn === 1 && (idx < 0 || idx > 6)) return;
            if (turn === 2 && (idx < 8 || idx > 14)) return;

            // Validate seeds
            if (board[idx] === 0) return;

            // Start Sowing
            phase = 'animating';
            highlightValidHoles(false); // Clear highlights

            sow(idx);
        }

        async function sow(startIndex) {
            let hand = board[startIndex];
            board[startIndex] = 0;
            updateVisuals();

            let current = startIndex;

            while (hand > 0) {
                current = (current + 1) % 16;

                // Skip Opponent Store
                if (turn === 1 && current === 15) continue;
                if (turn === 2 && current === 7) continue;

                // Drop seed
                board[current]++;
                hand--;
                updateVisuals(); // In a real app we'd animate the seed flying
                await new Promise(r => setTimeout(r, 200)); // Speed
            }

            // Hand empty, check landing (current)

            // 1. Land in Own Store -> Go Again (Math required!)
            if ((turn === 1 && current === 7) || (turn === 2 && current === 15)) {
                // Extra turn
                const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
                qEl.innerText = "BONUS TURN!";
                await new Promise(r => setTimeout(r, 1000));
                setTurn(turn); // Restart Math Phase
                return;
            }

            // 2. Land in Occupied Hole (not store) -> Continue Sowing (Embat / Lanjut)
            if (current !== 7 && current !== 15 && board[current] > 1) {
                // Continue with these seeds
                const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
                qEl.innerText = "LANJUT!";
                await new Promise(r => setTimeout(r, 500));

                // Recursive sow (taking content of current)
                // Note: board[current] includes the 1 we just dropped.
                // So we pick up everything.
                await sow(current);
                return;
            }

            // 3. Land in Empty Hole (Mati or Nembak)
            if (board[current] === 1) { // It was 0, now 1
                // Check if on OWN side
                let ownSide = (turn === 1 && current >= 0 && current <= 6) || (turn === 2 && current >= 8 && current <= 14);

                if (ownSide) {
                    // NEMBAK! (Capture opposite)
                    // Opposite index: 14 - current (0->14, 1->13...)
                    // Wait, standard mapping:
                    // 0 <-> 14, 1 <-> 13, 6 <-> 8. Formula: 14 - index.
                    let oppIndex = 14 - current;

                    if (board[oppIndex] > 0) {
                        // Capture!
                        let captured = board[oppIndex];
                        let mySeed = board[current];
                        board[oppIndex] = 0;
                        board[current] = 0;

                        let myStore = turn === 1 ? 7 : 15;
                        board[myStore] += (captured + mySeed);

                        const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
                        qEl.innerText = "TEMBAK!! +" + (captured + mySeed);
                        confetti({ particleCount: 50, spread: 50, origin: { y: 0.5 } });
                        updateVisuals();
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                // End Turn (Mati)
                const qEl = turn === 1 ? document.getElementById('q-p1') : document.getElementById('q-p2');
                qEl.innerText = "GANTI GILIRAN";
                await new Promise(r => setTimeout(r, 1000));
                setTurn(turn === 1 ? 2 : 1);
            }
        }

        function updateVisuals() {
            for (let i = 0; i < 16; i++) {
                let idID = i;
                if (i < 10) idID = '0' + i; // for 0-9
                // Holes 0-6, 8-14
                if (i !== 7 && i !== 15) {
                    let el = document.getElementById(`count-${i}`); // span
                    if (el) el.innerText = board[i];

                    // Optional: Render Seeds as divs?
                    // For now simplicity: just number.
                } else {
                    // Stores
                    let el = document.getElementById(`count-${i}`);
                    if (el) el.innerText = board[i];
                }
            }
        }

        function endGame() {
            document.getElementById('screen-result').classList.remove('hidden');
            let s1 = board[7];
            let s2 = board[15];

            // Add remaining seeds on board to respective owners?
            // Standard rule: remaining seeds stay, or are captured by owner?
            // Simplified: Just count stores + seeds on side.
            for (let i = 0; i <= 6; i++) s1 += board[i];
            for (let i = 8; i <= 14; i++) s2 += board[i];

            document.getElementById('final-p1').innerText = s1;
            document.getElementById('final-p2').innerText = s2;

            if (s1 > s2) {
                document.getElementById('result-text').innerText = "PEMAIN 1 MENANG!";
                document.getElementById('result-text').className = "text-6xl font-bold mb-4 font-fun text-blue-600";
            } else if (s2 > s1) {
                document.getElementById('result-text').innerText = "PEMAIN 2 MENANG!";
                document.getElementById('result-text').className = "text-6xl font-bold mb-4 font-fun text-red-600";
            } else {
                document.getElementById('result-text').innerText = "SERI!";
                document.getElementById('result-text').className = "text-6xl font-bold mb-4 font-fun text-gray-800";
            }
            confetti({ particleCount: 300, spread: 150 });
        }

    </script>
</body>

</html>



